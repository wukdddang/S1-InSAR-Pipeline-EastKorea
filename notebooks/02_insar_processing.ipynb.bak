{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "0fcc6d3d",
   "metadata": {},
   "source": [
    "# Sentinel-1 InSAR Processing\n",
    "\n",
    "ì´ ë…¸íŠ¸ë¶ì€ Sentinel-1 SLC ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ DInSAR(Differential Interferometric SAR) ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.\n",
    "\n",
    "## ëª©í‘œ\n",
    "- SLC ë°ì´í„° ì „ì²˜ë¦¬\n",
    "- ê°„ì„­ë„(Interferogram) ìƒì„±\n",
    "- ìœ„ìƒ ì–¸ë˜í•‘(Phase Unwrapping)\n",
    "- ì§€í‘œ ë³€ìœ„ ë§µ ìƒì„±\n",
    "\n",
    "## í•„ìš” ë¦¬ì†ŒìŠ¤ ğŸ’»\n",
    "\n",
    "### ìµœì†Œ ì‚¬ì–‘\n",
    "- **CPU**: 4 cores (Intel i5 ì´ìƒ)\n",
    "- **RAM**: 16 GB\n",
    "- **Disk**: 50 GB ì—¬ìœ  ê³µê°„\n",
    "- **ì²˜ë¦¬ ì‹œê°„**: 2-4 ì‹œê°„ (ê°„ì„­ìŒ 1ê°œ ê¸°ì¤€)\n",
    "\n",
    "### ê¶Œì¥ ì‚¬ì–‘\n",
    "- **CPU**: 8+ cores (Intel i7/i9, AMD Ryzen 7/9)\n",
    "- **RAM**: 32 GB ì´ìƒ\n",
    "- **Disk**: 100 GB SSD\n",
    "- **GPU**: CUDA ì§€ì› (SNAP GPU ê°€ì†ìš©)\n",
    "- **ì²˜ë¦¬ ì‹œê°„**: 1-2 ì‹œê°„\n",
    "\n",
    "### í´ë¼ìš°ë“œ ì˜µì…˜ â˜ï¸\n",
    "- **AWS EC2**: c5.2xlarge (8 vCPU, 16 GB RAM) - ~$0.34/hr\n",
    "- **Google Compute**: n2-standard-8 (8 vCPU, 32 GB RAM) - ~$0.39/hr\n",
    "- **Azure**: Standard_D8s_v3 (8 vCPU, 32 GB RAM) - ~$0.38/hr"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "01d57847",
   "metadata": {},
   "source": [
    "## Step 1: Environment Setup\n",
    "\n",
    "### Windows í™˜ê²½ ì²´í¬\n",
    "\n",
    "**Windowsì—ì„œ ì½”ë“œë¡œ InSAR ì²˜ë¦¬í•˜ë ¤ë©´ WSL2ê°€ í•„ìš”í•©ë‹ˆë‹¤!**\n",
    "\n",
    "#### ì˜µì…˜ 1: WSL2 ì„¤ì¹˜ (ê¶Œì¥ â­)\n",
    "```bash\n",
    "# Windows PowerShell (ê´€ë¦¬ì ê¶Œí•œ)\n",
    "wsl --install -d Ubuntu-22.04\n",
    "\n",
    "# ì¬ë¶€íŒ… í›„ Ubuntu ì‹¤í–‰\n",
    "wsl\n",
    "\n",
    "# Conda ì„¤ì¹˜ (WSL ë‚´ë¶€)\n",
    "wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh\n",
    "bash Miniconda3-latest-Linux-x86_64.sh\n",
    "\n",
    "# InSAR í™˜ê²½ êµ¬ì„±\n",
    "conda create -n insar python=3.9\n",
    "conda activate insar\n",
    "conda install -c conda-forge gdal rasterio geopandas isce2\n",
    "pip install asf-search jupyter\n",
    "\n",
    "# Jupyterì—ì„œ WSL ì»¤ë„ ì‚¬ìš© ê°€ëŠ¥!\n",
    "```\n",
    "\n",
    "#### ì˜µì…˜ 2: Python InSAR ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì‹¤í—˜ì )\n",
    "```bash\n",
    "# Windowsì—ì„œë„ ì‘ë™ (ê¸°ëŠ¥ ì œí•œì )\n",
    "pip install sarpy pyinsar\n",
    "```\n",
    "\n",
    "#### ì˜µì…˜ 3: SNAP snappy (ë³µì¡í•¨)\n",
    "- GUI ì„¤ì¹˜ í•„ìˆ˜\n",
    "- Python API ì„¤ì • ë³µì¡"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "23e7cca4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Operating System: Linux\n",
      "âœ“ Linux detected - InSAR software can be installed\n",
      "\n",
      "âœ“ Libraries loaded successfully\n",
      "\n",
      "=== InSAR Software Check ===\n",
      "Using default ISCE Path: /home/wukddang/miniconda3/envs/insar/lib/python3.9/site-packages/isce\n",
      "âœ“ ISCE2 available\n",
      "âœ— PyGMTSAR not installed\n",
      "âœ— SNAP Python API not installed\n",
      "âœ— SarPy not installed\n",
      "\n",
      "âœ“ Ready for InSAR processing!\n"
     ]
    }
   ],
   "source": [
    "import sys\n",
    "import platform\n",
    "sys.path.append('../')\n",
    "\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "from pathlib import Path\n",
    "import zipfile\n",
    "from datetime import datetime\n",
    "import xml.etree.ElementTree as ET\n",
    "from rich.console import Console\n",
    "\n",
    "console = Console()\n",
    "\n",
    "# Check operating system\n",
    "os_name = platform.system()\n",
    "print(f\"Operating System: {os_name}\")\n",
    "if os_name == \"Windows\":\n",
    "    print(\"âš ï¸  Windows detected! InSAR software requires WSL2 or Linux.\")\n",
    "    print(\"   See installation guide above.\")\n",
    "elif os_name == \"Linux\":\n",
    "    print(\"âœ“ Linux detected - InSAR software can be installed\")\n",
    "elif os_name == \"Darwin\":\n",
    "    print(\"âœ“ macOS detected - InSAR software can be installed\")\n",
    "\n",
    "print(\"\\nâœ“ Libraries loaded successfully\")\n",
    "\n",
    "# Check available InSAR software\n",
    "print(\"\\n=== InSAR Software Check ===\")\n",
    "insar_available = False\n",
    "\n",
    "try:\n",
    "    import isce\n",
    "    print(\"âœ“ ISCE2 available\")\n",
    "    insar_available = True\n",
    "except ImportError:\n",
    "    print(\"âœ— ISCE2 not installed\")\n",
    "\n",
    "try:\n",
    "    import pygmtsar\n",
    "    print(\"âœ“ PyGMTSAR available\")\n",
    "    insar_available = True\n",
    "except ImportError:\n",
    "    print(\"âœ— PyGMTSAR not installed\")\n",
    "\n",
    "try:\n",
    "    import snappy\n",
    "    print(\"âœ“ SNAP Python API available\")\n",
    "    insar_available = True\n",
    "except ImportError:\n",
    "    print(\"âœ— SNAP Python API not installed\")\n",
    "\n",
    "# Alternative Python libraries\n",
    "try:\n",
    "    import sarpy\n",
    "    print(\"âœ“ SarPy available (basic SAR processing)\")\n",
    "    insar_available = True\n",
    "except ImportError:\n",
    "    print(\"âœ— SarPy not installed\")\n",
    "\n",
    "if not insar_available:\n",
    "    print(\"\\nâš ï¸  No InSAR software found!\")\n",
    "    if os_name == \"Windows\":\n",
    "        print(\"\\nğŸ’¡ Recommended: Install WSL2\")\n",
    "        print(\"   PowerShell (Admin): wsl --install -d Ubuntu-22.04\")\n",
    "        print(\"   Then install ISCE2 in WSL\")\n",
    "    else:\n",
    "        print(\"\\nğŸ’¡ Install InSAR software:\")\n",
    "        print(\"   conda install -c conda-forge isce2\")\n",
    "else:\n",
    "    print(\"\\nâœ“ Ready for InSAR processing!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "40f0d96e",
   "metadata": {},
   "source": [
    "## Step 2: Load SLC Data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "b7eeaedf",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "================================================================================\n",
      "SLC Data Files\n",
      "================================================================================\n",
      "\n",
      "Data directory: ../data/raw\n",
      "Number of SLC files: 2\n",
      "\n",
      "Master: S1A_IW_SLC__1SDV_20230320T092352_20230320T092420_047726_05BBA5_AE9C.zip\n",
      "  Size: 4.20 GB\n",
      "\n",
      "Slave: S1A_IW_SLC__1SDV_20231221T092331_20231221T092350_051751_064013_B348.zip\n",
      "  Size: 4.62 GB\n"
     ]
    }
   ],
   "source": [
    "# Data directory\n",
    "data_dir = Path('../data/raw')\n",
    "slc_files = sorted(list(data_dir.glob('*.zip')))\n",
    "\n",
    "print(\"=\" * 80)\n",
    "print(\"SLC Data Files\")\n",
    "print(\"=\" * 80)\n",
    "print(f\"\\nData directory: {data_dir}\")\n",
    "print(f\"Number of SLC files: {len(slc_files)}\\n\")\n",
    "\n",
    "if len(slc_files) >= 2:\n",
    "    master_file = slc_files[0]\n",
    "    slave_file = slc_files[1]\n",
    "    \n",
    "    print(f\"Master: {master_file.name}\")\n",
    "    print(f\"  Size: {master_file.stat().st_size / (1024**3):.2f} GB\")\n",
    "    \n",
    "    print(f\"\\nSlave: {slave_file.name}\")\n",
    "    print(f\"  Size: {slave_file.stat().st_size / (1024**3):.2f} GB\")\n",
    "else:\n",
    "    print(\"âš ï¸  At least 2 SLC files are required for InSAR processing!\")\n",
    "    print(\"Download data first: python run_data_search.py --download --max-products 2\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a6b321b3",
   "metadata": {},
   "source": [
    "## Step 3: InSAR Processing Workflow\n",
    "\n",
    "### ì²˜ë¦¬ ë‹¨ê³„ ê°œìš”\n",
    "\n",
    "```\n",
    "1. Co-registration      â†’ Image alignment (Master-Slave)\n",
    "2. Interferogram        â†’ Phase difference calculation\n",
    "3. Topographic Phase    â†’ DEM-based topographic phase removal\n",
    "4. Filtering            â†’ Noise reduction (Goldstein filter)\n",
    "5. Phase Unwrapping     â†’ Remove 2Ï€ ambiguity\n",
    "6. Geocoding            â†’ Radar â†’ Geographic coordinates\n",
    "7. Displacement Map     â†’ Generate displacement map (mm)\n",
    "```\n",
    "\n",
    "### Processing Time Estimates â±ï¸\n",
    "\n",
    "| Step | Time (16GB RAM) | Time (32GB RAM) |\n",
    "|------|----------------|----------------|\n",
    "| Co-registration | 10-15 min | 5-10 min |\n",
    "| Interferogram | 5-10 min | 3-5 min |\n",
    "| Filtering | 10-15 min | 5-10 min |\n",
    "| Phase Unwrapping | 30-60 min | 15-30 min |\n",
    "| Geocoding | 10-15 min | 5-10 min |\n",
    "| **Total** | **~2-4 hours** | **~1-2 hours** |\n",
    "\n",
    "### Disk Space Requirements ğŸ’¾\n",
    "\n",
    "- Input SLC (2 files): ~8 GB\n",
    "- Intermediate files: ~20 GB\n",
    "- Final outputs: ~2 GB\n",
    "- **Total**: ~30 GB"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "021f0479",
   "metadata": {},
   "source": [
    "## Step 4: ISCE2 InSAR Processing â­ (Recommended)\n",
    "\n",
    "ISCE2ëŠ” ì„¤ì¹˜ê°€ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ ì‚¬ìš©í•œ ì‹¤ì œ InSAR ì²˜ë¦¬ ì›Œí¬í”Œë¡œìš°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.\n",
    "\n",
    "**ì¥ì **:\n",
    "- âœ… Python APIë¡œ ìë™í™” ê°€ëŠ¥\n",
    "- âœ… Sentinel-1 TOPS ëª¨ë“œ ì™„ë²½ ì§€ì›\n",
    "- âœ… ì˜¤í”ˆì†ŒìŠ¤ ë° í™œë°œí•œ ì»¤ë®¤ë‹ˆí‹°\n",
    "- âœ… ë†’ì€ ì²˜ë¦¬ ì •í™•ë„\n",
    "\n",
    "**âš ï¸ ì£¼ì˜**: \n",
    "- ì „ì²´ ì²˜ë¦¬ëŠ” **1-4ì‹œê°„** ì†Œìš”ë©ë‹ˆë‹¤\n",
    "- **30GB** ì´ìƒì˜ ë””ìŠ¤í¬ ê³µê°„ì´ í•„ìš”í•©ë‹ˆë‹¤\n",
    "- ì²˜ë¦¬ ì¤‘ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë†’ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a95e88e8",
   "metadata": {},
   "source": [
    "### 4.1 ISCE2 Setup"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "b529442d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "================================================================================\n",
      "ISCE2 InSAR Processing Setup\n",
      "================================================================================\n",
      "\n",
      "âœ“ ISCE2 version: 2.6.3\n",
      "âœ“ ISCE2 path: /home/wukddang/miniconda3/envs/insar/lib/python3.9/site-packages/isce\n",
      "\n",
      "âœ“ Processing directories created:\n",
      "  - Master: ../data/insar_processing/master\n",
      "  - Slave: ../data/insar_processing/slave\n",
      "  - Output: ../data/insar_processing/output\n",
      "\n",
      "=== SLC Information ===\n",
      "\n",
      "Master:\n",
      "  Date: 2023-03-20\n",
      "  Satellite: Sentinel-1A\n",
      "  Orbit: 047726\n",
      "\n",
      "Slave:\n",
      "  Date: 2023-12-21\n",
      "  Satellite: Sentinel-1A\n",
      "  Orbit: 051751\n",
      "\n",
      "Temporal Baseline: 275 days\n",
      "\n",
      "âœ“ ISCE2 setup complete!\n",
      "\n",
      "ğŸ’¡ Next: Run ISCE2 processing workflow below\n"
     ]
    }
   ],
   "source": [
    "# ISCE2 Processing Setup\n",
    "import os\n",
    "import shutil\n",
    "\n",
    "print(\"=\" * 80)\n",
    "print(\"ISCE2 InSAR Processing Setup\")\n",
    "print(\"=\" * 80)\n",
    "\n",
    "# Check ISCE2 availability\n",
    "try:\n",
    "    import isce\n",
    "    from isceobj.Sensor import createSensor\n",
    "    print(f\"\\nâœ“ ISCE2 version: {isce.__version__ if hasattr(isce, '__version__') else 'installed'}\")\n",
    "    print(f\"âœ“ ISCE2 path: {isce.__path__[0]}\")\n",
    "    \n",
    "    # Create processing directories\n",
    "    work_dir = Path('../data/insar_processing')\n",
    "    work_dir.mkdir(parents=True, exist_ok=True)\n",
    "    \n",
    "    master_dir = work_dir / 'master'\n",
    "    slave_dir = work_dir / 'slave'\n",
    "    output_dir = work_dir / 'output'\n",
    "    \n",
    "    for d in [master_dir, slave_dir, output_dir]:\n",
    "        d.mkdir(exist_ok=True)\n",
    "    \n",
    "    print(f\"\\nâœ“ Processing directories created:\")\n",
    "    print(f\"  - Master: {master_dir}\")\n",
    "    print(f\"  - Slave: {slave_dir}\")\n",
    "    print(f\"  - Output: {output_dir}\")\n",
    "    \n",
    "    # Extract SLC metadata for ISCE2 configuration\n",
    "    import re\n",
    "    from datetime import datetime\n",
    "    \n",
    "    def parse_s1_filename(filepath):\n",
    "        \"\"\"Sentinel-1 íŒŒì¼ëª…ì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ\"\"\"\n",
    "        filename = Path(filepath).name\n",
    "        pattern = r'S1([AB])_IW_SLC__1S([DV][HV])_(\\d{8}T\\d{6})_(\\d{8}T\\d{6})_(\\d{6})_([A-F0-9]{6})_([A-F0-9]{4})'\n",
    "        match = re.match(pattern, filename)\n",
    "        \n",
    "        if match:\n",
    "            return {\n",
    "                'satellite': f\"Sentinel-1{match.group(1)}\",\n",
    "                'polarization': match.group(2),\n",
    "                'start_time': datetime.strptime(match.group(3), '%Y%m%dT%H%M%S'),\n",
    "                'end_time': datetime.strptime(match.group(4), '%Y%m%dT%H%M%S'),\n",
    "                'orbit': match.group(5),\n",
    "                'mission_id': match.group(6),\n",
    "                'product_id': match.group(7)\n",
    "            }\n",
    "        return None\n",
    "    \n",
    "    master_meta = parse_s1_filename(master_file)\n",
    "    slave_meta = parse_s1_filename(slave_file)\n",
    "    \n",
    "    print(f\"\\n=== SLC Information ===\")\n",
    "    print(f\"\\nMaster:\")\n",
    "    print(f\"  Date: {master_meta['start_time'].strftime('%Y-%m-%d')}\")\n",
    "    print(f\"  Satellite: {master_meta['satellite']}\")\n",
    "    print(f\"  Orbit: {master_meta['orbit']}\")\n",
    "    \n",
    "    print(f\"\\nSlave:\")\n",
    "    print(f\"  Date: {slave_meta['start_time'].strftime('%Y-%m-%d')}\")\n",
    "    print(f\"  Satellite: {slave_meta['satellite']}\")\n",
    "    print(f\"  Orbit: {slave_meta['orbit']}\")\n",
    "    \n",
    "    # Calculate temporal baseline\n",
    "    temporal_baseline = (slave_meta['start_time'] - master_meta['start_time']).days\n",
    "    print(f\"\\nTemporal Baseline: {temporal_baseline} days\")\n",
    "    \n",
    "    print(\"\\nâœ“ ISCE2 setup complete!\")\n",
    "    print(\"\\nğŸ’¡ Next: Run ISCE2 processing workflow below\")\n",
    "    \n",
    "except ImportError as e:\n",
    "    print(f\"\\nâŒ ISCE2 import error: {e}\")\n",
    "    print(\"\\nInstall ISCE2:\")\n",
    "    print(\"  conda install -c conda-forge isce2\")\n",
    "except Exception as e:\n",
    "    print(f\"\\nâŒ Setup error: {e}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1c4a98ff",
   "metadata": {},
   "source": [
    "### 4.2 ISCE2 Configuration\n",
    "\n",
    "ISCE2ë¥¼ ì‚¬ìš©í•œ Sentinel-1 InSAR ì²˜ë¦¬ëŠ” **topsApp.py**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:\n",
    "\n",
    "1. **topsApp.py** - Sentinel-1 TOPS ëª¨ë“œ ì „ìš© ì²˜ë¦¬ ì›Œí¬í”Œë¡œìš°\n",
    "2. XML ì„¤ì • íŒŒì¼ ìƒì„±\n",
    "3. ë‹¨ê³„ë³„ ì‹¤í–‰ ë˜ëŠ” ì „ì²´ ìë™ ì‹¤í–‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0e949906",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âŒ Error creating configuration: [Errno 2] No such file or directory: '../data/insar_processing/output/topsApp.xml'\n"
     ]
    }
   ],
   "source": [
    "# Generate ISCE2 topsApp.xml configuration\n",
    "def create_topsapp_xml(master_file, slave_file, output_dir, roi_bbox=None):\n",
    "    \"\"\"\n",
    "    ISCE2 topsApp.xml ì„¤ì • íŒŒì¼ ìƒì„±\n",
    "    \n",
    "    Parameters:\n",
    "    - master_file: Master SLC íŒŒì¼ ê²½ë¡œ\n",
    "    - slave_file: Slave SLC íŒŒì¼ ê²½ë¡œ\n",
    "    - output_dir: ì¶œë ¥ ë””ë ‰í† ë¦¬ (Path object)\n",
    "    - roi_bbox: ê´€ì‹¬ ì˜ì—­ [min_lat, max_lat, min_lon, max_lon] (ì„ íƒì‚¬í•­)\n",
    "    \"\"\"\n",
    "    \n",
    "    # ì¶œë ¥ ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±\n",
    "    output_dir.mkdir(parents=True, exist_ok=True)\n",
    "    \n",
    "    # í¬í•­/ê²½ì£¼ ì˜ì—­ ê¸°ë³¸ê°’ (í•œë°˜ë„ ë™ë‚¨ë¶€)\n",
    "    if roi_bbox is None:\n",
    "        roi_bbox = [35.5, 36.5, 128.5, 129.5]  # [min_lat, max_lat, min_lon, max_lon]\n",
    "    \n",
    "    xml_content = f\"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n",
    "<topsApp>\n",
    "  <component name=\"topsinsar\">\n",
    "    \n",
    "    <!-- Input SLC Data -->\n",
    "    <property name=\"Sensor name\">SENTINEL1</property>\n",
    "    \n",
    "    <component name=\"master\">\n",
    "      <property name=\"output directory\">{output_dir}/master</property>\n",
    "      <property name=\"safe\">{master_file}</property>\n",
    "    </component>\n",
    "    \n",
    "    <component name=\"slave\">\n",
    "      <property name=\"output directory\">{output_dir}/slave</property>\n",
    "      <property name=\"safe\">{slave_file}</property>\n",
    "    </component>\n",
    "    \n",
    "    <!-- Region of Interest -->\n",
    "    <property name=\"region of interest\">{roi_bbox}</property>\n",
    "    \n",
    "    <!-- DEM (SRTM 1-arcsec auto-download) -->\n",
    "    <property name=\"demFilename\">demLat_35_37_Lon_128_130.dem.wgs84</property>\n",
    "    <property name=\"do unwrap\">True</property>\n",
    "    <property name=\"unwrapper name\">snaphu_mcf</property>\n",
    "    \n",
    "    <!-- Processing Parameters -->\n",
    "    <property name=\"azimuth looks\">3</property>\n",
    "    <property name=\"range looks\">9</property>\n",
    "    <property name=\"filter strength\">0.5</property>\n",
    "    \n",
    "    <!-- Geocoding -->\n",
    "    <property name=\"geocode list\">['merged/filt_topophase.unw.geo']</property>\n",
    "    <property name=\"geocode bounding box\">{roi_bbox}</property>\n",
    "    \n",
    "  </component>\n",
    "</topsApp>\n",
    "\"\"\"\n",
    "    \n",
    "    xml_path = output_dir / 'topsApp.xml'\n",
    "    with open(xml_path, 'w') as f:\n",
    "        f.write(xml_content)\n",
    "    \n",
    "    return xml_path\n",
    "\n",
    "try:\n",
    "    # ë³€ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸\n",
    "    if 'output_dir' not in locals():\n",
    "        # ì´ì „ ì…€ì„ ì‹¤í–‰í•˜ì§€ ì•Šì€ ê²½ìš°\n",
    "        work_dir = Path('../data/insar_processing')\n",
    "        output_dir = work_dir / 'output'\n",
    "        print(\"âš ï¸  ë³€ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•„ ê¸°ë³¸ê°’ ì‚¬ìš©\")\n",
    "        print(f\"   output_dir: {output_dir}\")\n",
    "        \n",
    "    if 'master_file' not in locals() or 'slave_file' not in locals():\n",
    "        # SLC íŒŒì¼ ì¬í™•ì¸\n",
    "        data_dir = Path('../data/raw')\n",
    "        slc_files = sorted(list(data_dir.glob('*.zip')))\n",
    "        if len(slc_files) >= 2:\n",
    "            master_file = slc_files[0]\n",
    "            slave_file = slc_files[1]\n",
    "        else:\n",
    "            raise FileNotFoundError(\"SLC íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Step 2ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.\")\n",
    "    \n",
    "    # topsApp.py ê²½ë¡œ í™•ì¸\n",
    "    import isce\n",
    "    isce_apps_dir = Path(isce.__path__[0]) / 'applications'\n",
    "    topsapp_path = isce_apps_dir / 'topsApp.py'\n",
    "    \n",
    "    if not topsapp_path.exists():\n",
    "        raise FileNotFoundError(f\"topsApp.pyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {topsapp_path}\")\n",
    "    \n",
    "    # Generate topsApp.xml\n",
    "    xml_path = create_topsapp_xml(\n",
    "        master_file=str(master_file.resolve()),  # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©\n",
    "        slave_file=str(slave_file.resolve()),    # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©\n",
    "        output_dir=output_dir,\n",
    "        roi_bbox=[35.8, 36.2, 128.8, 129.4]  # í¬í•­/ê²½ì£¼ ì˜ì—­\n",
    "    )\n",
    "    \n",
    "    print(\"=\" * 80)\n",
    "    print(\"ISCE2 Configuration Generated\")\n",
    "    print(\"=\" * 80)\n",
    "    print(f\"\\nâœ“ Configuration file: {xml_path}\")\n",
    "    print(f\"\\nProcessing parameters:\")\n",
    "    print(f\"  - Master: {master_file.name}\")\n",
    "    print(f\"  - Slave: {slave_file.name}\")\n",
    "    print(f\"  - ROI: í¬í•­/ê²½ì£¼ ì˜ì—­ (35.8Â°N-36.2Â°N, 128.8Â°E-129.4Â°E)\")\n",
    "    print(f\"  - Azimuth looks: 3\")\n",
    "    print(f\"  - Range looks: 9\")\n",
    "    print(f\"  - Output: {output_dir.resolve()}\")\n",
    "    \n",
    "    print(f\"\\n{'='*80}\")\n",
    "    print(\"ISCE2 Processing Commands\")\n",
    "    print(\"=\" * 80)\n",
    "    print(f\"\\nâœ“ topsApp.py ìœ„ì¹˜: {topsapp_path}\")\n",
    "    print(\"\\nğŸš€ ì „ì²´ ìë™ ì‹¤í–‰ (1-4ì‹œê°„ ì†Œìš”):\")\n",
    "    print(f\"    cd {output_dir.resolve()}\")\n",
    "    print(f\"    python {topsapp_path} --steps\")\n",
    "    print(f\"    python {topsapp_path}\")\n",
    "    \n",
    "    print(\"\\nğŸ“‹ ë‹¨ê³„ë³„ ì‹¤í–‰ (ê¶Œì¥ - ë¬¸ì œ ë°œìƒ ì‹œ ì¤‘ê°„ë¶€í„° ì¬ê°œ ê°€ëŠ¥):\")\n",
    "    print(f\"    cd {output_dir.resolve()}\")\n",
    "    print(f\"    python {topsapp_path} --steps  # ì „ì²´ ë‹¨ê³„ ëª©ë¡ í™•ì¸\")\n",
    "    print(f\"    python {topsapp_path} --start=startup --end=preprocess\")\n",
    "    print(f\"    python {topsapp_path} --start=computeBaselines --end=verifyDEM\")\n",
    "    print(f\"    python {topsapp_path} --start=topo --end=geo2rdr\")\n",
    "    print(f\"    python {topsapp_path} --start=coarseoffsets --end=coarseresamp\")\n",
    "    print(f\"    python {topsapp_path} --start=misreg --end=refined_interferogram\")\n",
    "    print(f\"    python {topsapp_path} --start=unwrap --end=unwrap2stage\")\n",
    "    print(f\"    python {topsapp_path} --start=geocode --end=geocode\")\n",
    "    \n",
    "    print(\"\\nğŸ’¡ ì‹¤í–‰ ë°©ë²•:\")\n",
    "    print(\"    1. í„°ë¯¸ë„ì—ì„œ ìœ„ ëª…ë ¹ì–´ ì‹¤í–‰\")\n",
    "    print(\"    2. ë˜ëŠ” ì•„ë˜ ì…€ì—ì„œ subprocessë¡œ ì‹¤í–‰\")\n",
    "    \n",
    "    print(\"\\nâœ“ Configuration ready!\")\n",
    "    \n",
    "except FileNotFoundError as e:\n",
    "    print(f\"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}\")\n",
    "    print(\"\\nğŸ’¡ í•´ê²° ë°©ë²•:\")\n",
    "    print(\"    1. Step 1ê³¼ Step 2ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”\")\n",
    "    print(\"    2. SLC ë°ì´í„°ê°€ data/raw/ ë””ë ‰í† ë¦¬ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”\")\n",
    "except Exception as e:\n",
    "    print(f\"âŒ Error creating configuration: {e}\")\n",
    "    import traceback\n",
    "    traceback.print_exc()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d6a4d63a",
   "metadata": {},
   "source": [
    "### 4.3 Run ISCE2 Processing"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "37b1ceb4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "================================================================================\n",
      "Starting ISCE2 InSAR Processing\n",
      "================================================================================\n",
      "\n",
      "âš ï¸  This will take 1-4 hours depending on your system\n",
      "Press Ctrl+C to cancel\n",
      "\n",
      "\n",
      "1. Checking available processing steps...\n",
      "\n",
      "\n",
      "âŒ Error during processing: [Errno 2] No such file or directory: 'topsApp.py'\n"
     ]
    }
   ],
   "source": [
    "# Optional: Run ISCE2 processing from notebook\n",
    "import subprocess\n",
    "import time\n",
    "\n",
    "# ì‹¤í–‰ ì—¬ë¶€ í”Œë˜ê·¸ (ê¸´ ì²˜ë¦¬ ì‹œê°„ ë•Œë¬¸ì— ê¸°ë³¸ê°’ì€ False)\n",
    "RUN_ISCE2_PROCESSING = True\n",
    "\n",
    "if RUN_ISCE2_PROCESSING:\n",
    "    print(\"=\" * 80)\n",
    "    print(\"Starting ISCE2 InSAR Processing\")\n",
    "    print(\"=\" * 80)\n",
    "    print(\"\\nâš ï¸  This will take 1-4 hours depending on your system\")\n",
    "    print(\"Press Ctrl+C to cancel\\n\")\n",
    "    \n",
    "    time.sleep(3)  # 3ì´ˆ ëŒ€ê¸°\n",
    "    \n",
    "    try:\n",
    "        os.chdir(output_dir)\n",
    "        \n",
    "        # 1. Show processing steps\n",
    "        print(\"\\n1. Checking available processing steps...\")\n",
    "        result = subprocess.run(\n",
    "            ['topsApp.py', '--steps'],\n",
    "            capture_output=True,\n",
    "            text=True\n",
    "        )\n",
    "        print(result.stdout)\n",
    "        \n",
    "        # 2. Run full processing\n",
    "        print(\"\\n2. Running full InSAR processing...\")\n",
    "        print(\"   (This will take a long time - check progress in terminal)\")\n",
    "        \n",
    "        start_time = time.time()\n",
    "        \n",
    "        process = subprocess.Popen(\n",
    "            ['topsApp.py'],\n",
    "            stdout=subprocess.PIPE,\n",
    "            stderr=subprocess.STDOUT,\n",
    "            text=True,\n",
    "            bufsize=1,\n",
    "            universal_newlines=True\n",
    "        )\n",
    "        \n",
    "        # Print output in real-time\n",
    "        for line in process.stdout:\n",
    "            print(line, end='')\n",
    "        \n",
    "        process.wait()\n",
    "        \n",
    "        elapsed_time = time.time() - start_time\n",
    "        \n",
    "        if process.returncode == 0:\n",
    "            print(f\"\\n\\n{'='*80}\")\n",
    "            print(\"âœ… ISCE2 Processing Completed Successfully!\")\n",
    "            print(\"=\" * 80)\n",
    "            print(f\"Total processing time: {elapsed_time/3600:.2f} hours\")\n",
    "            print(f\"\\nOutput directory: {output_dir}\")\n",
    "            print(\"\\nGenerated products:\")\n",
    "            print(\"  - merged/filt_topophase.unw - Unwrapped phase\")\n",
    "            print(\"  - merged/filt_topophase.unw.geo - Geocoded unwrapped phase\")\n",
    "            print(\"  - merged/phsig.cor.geo - Coherence map\")\n",
    "            print(\"  - merged/los.rdr.geo - Line-of-sight geometry\")\n",
    "        else:\n",
    "            print(f\"\\n\\nâŒ ISCE2 Processing failed with return code {process.returncode}\")\n",
    "            print(\"Check the error messages above\")\n",
    "            \n",
    "    except KeyboardInterrupt:\n",
    "        print(\"\\n\\nâš ï¸  Processing interrupted by user\")\n",
    "    except Exception as e:\n",
    "        print(f\"\\n\\nâŒ Error during processing: {e}\")\n",
    "    finally:\n",
    "        os.chdir('..')  # Return to notebook directory\n",
    "        \n",
    "else:\n",
    "    print(\"=\" * 80)\n",
    "    print(\"ISCE2 Processing - Manual Execution Required\")\n",
    "    print(\"=\" * 80)\n",
    "    print(\"\\nâš ï¸  RUN_ISCE2_PROCESSING = False (default)\")\n",
    "    print(\"\\nì‹¤í–‰í•˜ë ¤ë©´:\")\n",
    "    print(\"  1. ìœ„ ì…€ì—ì„œ RUN_ISCE2_PROCESSING = Trueë¡œ ë³€ê²½\")\n",
    "    print(\"  2. ë˜ëŠ” í„°ë¯¸ë„ì—ì„œ ì§ì ‘ ì‹¤í–‰:\")\n",
    "    print(f\"\\n     cd {output_dir}\")\n",
    "    print(f\"     topsApp.py\")\n",
    "    print(\"\\nğŸ’¡ ê¶Œì¥: í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰í•˜ê³  tmux/screenìœ¼ë¡œ ì„¸ì…˜ ìœ ì§€\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cbeada2d",
   "metadata": {},
   "source": [
    "## Step 5: Alternative - SNAP Processing (Optional)\n",
    "\n",
    "SNAPì€ ESAì—ì„œ ì œê³µí•˜ëŠ” ê³µì‹ Sentinel-1 ì²˜ë¦¬ ë„êµ¬ì…ë‹ˆë‹¤.\n",
    "\n",
    "**SNAP vs ISCE2 ë¹„êµ**:\n",
    "\n",
    "| í•­ëª© | ISCE2 â­ | SNAP |\n",
    "|------|---------|------|\n",
    "| ì„¤ì¹˜ ìƒíƒœ | âœ… ì„¤ì¹˜ë¨ | âŒ ë¯¸ì„¤ì¹˜ |\n",
    "| Python API | âœ… ê°„í¸ | âš ï¸ ë³µì¡ (snappy ì„¤ì • í•„ìš”) |\n",
    "| ìë™í™” | âœ… ì‰¬ì›€ | âš ï¸ ì–´ë ¤ì›€ |\n",
    "| ì²˜ë¦¬ ì†ë„ | â­â­â­â­ | â­â­â­ |\n",
    "| GUI | âŒ ì—†ìŒ | âœ… ìˆìŒ (ì´ˆë³´ì ì¹œí™”ì ) |\n",
    "\n",
    "**ğŸ’¡ ê¶Œì¥**: ISCE2 ì‚¬ìš© (ì´ë¯¸ ì„¤ì¹˜ë¨, ìë™í™” ì‰¬ì›€)\n",
    "\n",
    "SNAPì´ í•„ìš”í•œ ê²½ìš°ë§Œ ì•„ë˜ ì„¤ì¹˜ ê°€ì´ë“œë¥¼ ë”°ë¼ ì„¤ì¹˜í•˜ì„¸ìš”."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "76aa13b2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# SNAP Processing Example (requires snappy installation)\n",
    "try:\n",
    "    import snappy\n",
    "    from snappy import ProductIO, GPF\n",
    "    \n",
    "    print(\"=\" * 80)\n",
    "    print(\"SNAP InSAR Processing\")\n",
    "    print(\"=\" * 80)\n",
    "    \n",
    "    # Read SLC products\n",
    "    print(\"\\n1. Reading Master SLC...\")\n",
    "    master = ProductIO.readProduct(str(master_file))\n",
    "    print(f\"   âœ“ Master loaded: {master.getName()}\")\n",
    "    \n",
    "    print(\"\\n2. Reading Slave SLC...\")\n",
    "    slave = ProductIO.readProduct(str(slave_file))\n",
    "    print(f\"   âœ“ Slave loaded: {slave.getName()}\")\n",
    "    \n",
    "    # Processing steps would continue here...\n",
    "    # (Full processing code omitted for brevity - see SNAP documentation)\n",
    "    \n",
    "    print(\"\\nğŸ’¡ Full SNAP processing workflow:\")\n",
    "    print(\"   1. TOPSAR-Split\")\n",
    "    print(\"   2. Apply-Orbit-File\")\n",
    "    print(\"   3. Back-Geocoding (Co-registration)\")\n",
    "    print(\"   4. Interferogram Formation\")\n",
    "    print(\"   5. TOPSAR-Deburst\")\n",
    "    print(\"   6. TopoPhaseRemoval\")\n",
    "    print(\"   7. GoldsteinPhaseFiltering\")\n",
    "    print(\"   8. PhaseUnwrapping (SNAPHU)\")\n",
    "    print(\"   9. PhaseToDisplacement\")\n",
    "    print(\"   10. Terrain-Correction (Geocoding)\")\n",
    "    \n",
    "    print(\"\\nâœ“ For complete processing code, see SNAP documentation:\")\n",
    "    print(\"   https://step.esa.int/main/doc/tutorials/\")\n",
    "    \n",
    "except ImportError:\n",
    "    print(\"âš ï¸  SNAP Python API (snappy) is not installed.\")\n",
    "    print(\"\\nğŸ’¡ ì¶”ì²œ: ISCE2ë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (Step 4 ì°¸ì¡°)\")\n",
    "    print(\"\\nSNAP ì„¤ì¹˜ê°€ í•„ìš”í•œ ê²½ìš°:\")\n",
    "    print(\"1. Download SNAP: https://step.esa.int/main/download/snap-download/\")\n",
    "    print(\"2. Configure snappy:\")\n",
    "    print(\"   cd <SNAP_INSTALL>/bin\")\n",
    "    print(\"   ./snappy-conf <PYTHON_EXE>\")\n",
    "except Exception as e:\n",
    "    print(f\"\\nâŒ Error: {e}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3cb07c16",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Note: This cell was a duplicate of Cell 14 (Step 5: SNAP Processing)\n",
    "# The SNAP processing code is available in Cell 14 above\n",
    "# This cell can be deleted or ignored"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b5a9922c",
   "metadata": {},
   "source": [
    "## Step 6: Visualize Results\n",
    "\n",
    "ISCE2 (Step 4) ë˜ëŠ” SNAP (Step 5) ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ ë³€ìœ„ ë§µì„ ì‹œê°í™”í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8410068f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load and visualize displacement map\n",
    "try:\n",
    "    import rasterio\n",
    "    from rasterio.plot import show\n",
    "    \n",
    "    # Check if processed data exists\n",
    "    processed_dir = Path('../data/processed')\n",
    "    geotiff_files = list(processed_dir.glob('*displacement*.tif'))\n",
    "    \n",
    "    if geotiff_files:\n",
    "        displacement_file = geotiff_files[0]\n",
    "        \n",
    "        print(f\"Loading displacement map: {displacement_file.name}\")\n",
    "        \n",
    "        with rasterio.open(displacement_file) as src:\n",
    "            displacement = src.read(1)\n",
    "            \n",
    "            # Plot\n",
    "            fig, ax = plt.subplots(figsize=(12, 10))\n",
    "            \n",
    "            im = ax.imshow(displacement, cmap='RdYlBu_r', vmin=-50, vmax=50)\n",
    "            ax.set_title('Ground Displacement Map (mm)', fontsize=14, fontweight='bold')\n",
    "            ax.set_xlabel('Longitude', fontsize=12)\n",
    "            ax.set_ylabel('Latitude', fontsize=12)\n",
    "            \n",
    "            # Colorbar\n",
    "            cbar = plt.colorbar(im, ax=ax, fraction=0.046, pad=0.04)\n",
    "            cbar.set_label('Displacement (mm)', rotation=270, labelpad=20, fontsize=12)\n",
    "            \n",
    "            plt.tight_layout()\n",
    "            plt.show()\n",
    "            \n",
    "            # Statistics\n",
    "            print(\"\\n=== Displacement Statistics ===\")\n",
    "            print(f\"Min: {np.nanmin(displacement):.2f} mm\")\n",
    "            print(f\"Max: {np.nanmax(displacement):.2f} mm\")\n",
    "            print(f\"Mean: {np.nanmean(displacement):.2f} mm\")\n",
    "            print(f\"Std: {np.nanstd(displacement):.2f} mm\")\n",
    "    else:\n",
    "        print(\"âš ï¸  No processed displacement map found.\")\n",
    "        print(\"Run InSAR processing first (Step 4)\")\n",
    "        \n",
    "except ImportError:\n",
    "    print(\"âš ï¸  rasterio is required for visualization\")\n",
    "    print(\"Install: pip install rasterio\")\n",
    "except Exception as e:\n",
    "    print(f\"Error: {e}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e291813a",
   "metadata": {},
   "source": [
    "## Next Steps ğŸš€\n",
    "\n",
    "### Completed âœ…\n",
    "- InSAR processing workflow understanding\n",
    "- Software requirements check\n",
    "- Resource estimation\n",
    "\n",
    "### To Do ğŸ“\n",
    "\n",
    "1. **Install InSAR Software**\n",
    "   - SNAP (recommended for beginners)\n",
    "   - ISCE2 (for advanced users)\n",
    "   - PyGMTSAR (for automation)\n",
    "\n",
    "2. **Run Processing**\n",
    "   - Use SNAP GUI for first-time processing\n",
    "   - Automate with Python after understanding workflow\n",
    "\n",
    "3. **Time-series Analysis** â†’ `03_time_series_analysis.ipynb`\n",
    "   - SBAS (Small Baseline Subset)\n",
    "   - Velocity estimation\n",
    "   - Atmospheric correction\n",
    "\n",
    "4. **Advanced Visualization** â†’ `04_visualization.ipynb`\n",
    "   - Interactive maps (Folium)\n",
    "   - 3D visualization\n",
    "\n",
    "---\n",
    "\n",
    "### Installation Guides ğŸ“š\n",
    "\n",
    "#### SNAP Installation\n",
    "```bash\n",
    "# 1. Download SNAP from:\n",
    "#    https://step.esa.int/main/download/snap-download/\n",
    "\n",
    "# 2. Install SNAP (GUI installer)\n",
    "\n",
    "# 3. Configure Python API:\n",
    "cd <SNAP_INSTALL_DIR>/bin\n",
    "./snappy-conf <YOUR_PYTHON_EXE>\n",
    "\n",
    "# 4. Test installation:\n",
    "python -c \"import snappy; print(snappy.__version__)\"\n",
    "```\n",
    "\n",
    "#### ISCE2 Installation\n",
    "```bash\n",
    "# Using conda (recommended):\n",
    "conda install -c conda-forge isce2\n",
    "\n",
    "# Test:\n",
    "python -c \"import isce; print(isce.__version__)\"\n",
    "```\n",
    "\n",
    "#### PyGMTSAR Installation\n",
    "```bash\n",
    "pip install pygmtsar\n",
    "\n",
    "# Test:\n",
    "python -c \"import pygmtsar; print(pygmtsar.__version__)\"\n",
    "```\n",
    "\n",
    "---\n",
    "\n",
    "**ğŸ’¡ Tip**: Start with SNAP GUI to understand the workflow, then automate with Python scripts."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "insar",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.18"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
